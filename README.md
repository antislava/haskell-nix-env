# Basic haskell nix development environment

Simple haskell development environment based on `nix` and `make`.
To be used promarily for the incremental development using cabal new-[build/repl] and ghcid.
Currently assumes vi as the main editor (but not critical).

## Features
* Simple/flexible/extensible setup (without multiple layers of nix functions).
* Allows declaring the nix shell environment completely via `default-flex.nix`, the main makefile (`./Makefile`), and the contents of the `hask-deps` directory.
* Minimises set-up time and time and effort needed to add dependency overrides in a way facilitating version control and reproducibility.
* Provides nix functions for generating tag file for code browsing.

## Usage
* Add standard nix files for the target packages to work on. These are normally generated by `cabal2nix`. `haskell.vim` file provides a function for generarting these automatically on saving the respective hpack `package.yaml` files. Package source directories can (and probably should) be in separate directories.
* Run `make nix/nixpkgs.git.json` to pull in the latest `nixpkgs` snapshot (`nixpkgs.git.json` should be added to the version control). Use `make -B` to update the existing snapshot.
* Specify target package nix files in `default-flex.nix`.
* Add haskell dependency overrides in `default-flex.nix` and, if necessary, by providing custom nix files per package in `hask-deps` folder. Use `hask-deps/Makefile` rules to generate and update these in the future.
* Customise (add or subtract) dependencies to be pulled in into development nix shell and for tagging in `default.nix` if necessary
* Run e.g. `make shell86` to enter development ghc-8.6.1 nix shell. Use `cabal new-*` or `ghci` for development.
  - `ghc-pkg-list_ghcXXX.txt` with the list of available haskell dependencies are generated on entering the shell. Add these to version control, if necessary for keeping track of the project dependencies.
* In the nix shell, run `make tags` to collect dependency sources (in `haskdeps`) and generate the tag file.
* `make` rules in `./Makefile` and `./hask-deps/Makefile` are trivial and should be customised as necessary. Also, `default-flex.nix` is meant to be heavily hacked on. These are the main configuration files for declaring the development environment.

## Adding haskell dependency overrides
If `shell-nix` reports errors (that cannot be easily resolved with `dontCheck` and `jailbreak` functions in `default-flex.nix`) add custom nix files in `./hask-deps` folder. The suggested way to tdo that is to that is by adding `<package>.sh` file containing a sufficient `cabal2nix` command, e.g.

```sh
cd ./hask-deps
echo "cabal2nix cabal://semigroupoids" > semigroupoids.sh
# or
echo "cabal2nix http://github.com/ekmett/semigroupoids" > semigroupoids.sh
# then
make semigroupoids.nix
```
and add the package name to `./default-flex.nix` override section.
Use `make -B <package>.nix` to update the nix file to the most recent version/commit (presuming the `<package>.nix` files are under version control and can be reverted if necessary.

**Tip:** The output of `cabal2nix cabal://<package>` usually contains the package github address if you would like to fetch the package from github (which is preferrable from the point of view of reproducibility) and are too lazy to look it up on hackage or elsewhere.  
